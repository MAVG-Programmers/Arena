var game = {
        requestAnimationFrame:
            window.requestAnimationFrame ||
            window.webkitRequestAnimationFrame ||
            window.mozRequestAnimationFrame ||
            window.oRequestAnimationFrame ||
            window.msRequestAnimationFrame,
        animation_fps: 60
    },
    player = {
        speed: 1 // this should be sent by server!
    };

game.init = function() {
    audio.init();

    //Initialize canvas
    game.canvas = $("#canvas");
    game.ctx = game.canvas[0].getContext("2d");
    game.width = game.canvas.width();
    game.height = game.canvas.height();

    //requestAnimationFrame will break if it is called in a context other than window, so it needs to be bound to the window object
    if(game.requestAnimationFrame) {
        game.requestAnimationFrame = game.requestAnimationFrame.bind(window);
    }

    //player.x = (game.width / 2) - 16;
    //player.y = (game.height / 2) - 16; generated by server instead

    player.sprite = new Sprite({
        width: 32,
        height: 32,
        path: "img/player.png"
    });

    game.mainLoop();
};

game.mainLoop = function() {


    game.ctx.clearRect(0, 0, game.width, game.height);


    // collision debugging
    //console.log('collision test: ' + debugCollisionManager.AABB({x: player.x, y: player.y, width: player.sprite.width, height: player.sprite.height}, debugRect))
    game.ctx.fillStyle = 'black';
    game.ctx.fillRect(debugRect.x, debugRect.y, debugRect.width, debugRect.height);
    // ---

    // bullet debugging
    Bullet.updateBullets();
    Bullet.drawBullets();
    // ---

    Player.drawPlayers();
    
    player.sprite.draw(player.x, player.y);

    var move = {x: 0, y: 0};
    if(heldkeys[KEYS.RIGHT]) {
        player.x += player.speed;
        move.x = player.speed;
    }

    if(heldkeys[KEYS.LEFT]) {
        player.x -= player.speed;
        move.x = - player.speed;
    }

    if(heldkeys[KEYS.DOWN]) {
        player.y += player.speed;
        move.y = player.speed;
    }

    if(heldkeys[KEYS.UP]) {
        player.y -= player.speed;
        move.y = - player.speed;
    }

    if (move.x != 0 || move.y != 0)
    {
        var angle = Math.atan2(move.y, move.x);
        socket.emit('move', angle); // Sends movement angle to server
    }

    //Execute next iteration
    if(game.requestAnimationFrame) {
        game.requestAnimationFrame(game.mainLoop);
    } else {
        setTimeout(game.mainLoop, 1000 / animation_fps);
    }
};